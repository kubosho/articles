name: Sync Articles

on:
  push:
    branches:
      - main
    paths:
      - 'src/**'
      - '.github/workflows/sync_articles.yaml'

  workflow_run:
    workflows:
      - 'CI'
    types:
      - completed

permissions:
  contents: read

jobs:
  sync:
    runs-on: ubuntu-24.04
    permissions:
      contents: read
    steps:
      - name: Checkout articles repository
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@67018539274d69449ef7c02e8e71183d1719ab42 # v2.1.4
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
          owner: kubosho
          repositories: blog.kubosho.com

      - name: Checkout blog repository
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          repository: kubosho/blog.kubosho.com
          path: blog
          ref: main
          fetch-depth: 0
          token: ${{ steps.app-token.outputs.token }}

      - name: Sync articles directory
        run: |
          set -euo pipefail
          mkdir -p blog/articles
          rsync -av --delete src/ blog/articles/

      - name: Commit updates in blog repository
        id: commit
        working-directory: blog
        env:
          SOURCE_SHA: ${{ github.sha }}
        run: |
          set -euo pipefail

          if [[ -z "$(git status --porcelain)" ]]; then
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add articles
          git commit -m "docs: sync articles from kubosho/articles@${SOURCE_SHA::7}"
          echo "has_changes=true" >> "$GITHUB_OUTPUT"

      - name: Push updates to blog repository
        if: steps.commit.outputs.has_changes == 'true'
        working-directory: blog
        run: git push origin HEAD:main
